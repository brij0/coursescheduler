{% load static %}
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>GPA Calculator</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    .course-block { margin-bottom: 1rem; padding: .5rem; border: 1px solid #ccc; }
    .assess-table { width: 100%; border-collapse: collapse; margin-top: .5rem; }
    .assess-table th, .assess-table td { border: 1px solid #ddd; padding: .3rem; }
    .term-selector { margin-bottom: 1.5rem; padding: 0.5rem; background: #f5f5f5; }
  </style>
</head>
<body>
  <h1>GPA Calculator</h1>
  
  <!-- Add term selector -->
  <div class="term-selector">
    <label>Select Term:
      <select id="offered-term" name="offered_term">
        <option value="">-- Select Term --</option>
      </select>
    </label>
  </div>
  
  <div id="courses-container"></div>
  <button id="add-course">Add Course</button>
  <hr>
  <button id="calc-gpa">Calculate GPA</button>
  <button id="export-excel" style="margin-bottom: 10px;">Export to Excel</button>

  <h2 id="result-header" style="display:none;">Results</h2>
  <div id="results"></div>

  <div class="auth-section" style="position: fixed; top: 10px; right: 10px; background: white; border: 1px solid #ccc; padding: 10px; border-radius: 5px;">
    <div id="auth-logged-out">
      <button id="login-btn">Login</button>
    </div>
    <div id="auth-logged-in" style="display:none;">
      <span>Welcome, <span id="username"></span>!</span>
      <button id="logout-btn">Logout</button>
    </div>
  </div>

  <!-- Login Modal -->
  <div id="login-modal" class="login-form" style="display:none; position:fixed; top:20%; left:50%; transform:translate(-50%,0); background:#f9f9f9; border-radius:5px; max-width:300px; z-index:1000; box-shadow:0 2px 8px rgba(0,0,0,0.2);">
    <h3>Login</h3>
    <div id="login-error" class="error" style="color:red; display:none;"></div>
    <input type="text" id="login-username" placeholder="Username" required />
    <input type="password" id="login-password" placeholder="Password" required />
    <button id="login-submit">Login</button>
    <button id="login-cancel">Cancel</button>
  </div>

<script>
let courseIdx = 0;

// Populate offered term dropdown from context
$(document).ready(function() {
  const sel = $('#offered-term');
  {% for term in offered_terms %}
    sel.append(`<option value="{{ term }}">{{ term }}</option>`);
  {% endfor %}
});

// Prefill from progress_data if available
$(document).ready(function() {
  {% if progress_data %}
    const progress = {{ progress_data|safe }};
    if (progress.offered_term) {
      $('#offered-term').val(progress.offered_term).trigger('change');
      // Wait for course types to load, then add courses
      setTimeout(function() {
        if (progress.courses && progress.courses.length) {
          $("#courses-container").empty();
          courseIdx = 0;
          progress.courses.forEach(function(course) {
            addCourseBlock();
            const block = $('.course-block').last();
            block.find('.ctype').val(course.course_type).trigger('change');
            setTimeout(function() {
              block.find('.ccode').val(course.course_code).trigger('change');
              setTimeout(function() {
                block.find('.csec').val(course.section_number).trigger('change');
                setTimeout(function() {
                  // Fill in assessments
                  if (course.assessments) {
                    course.assessments.forEach(function(a, i) {
                      block.find(`.achieved[data-ev-id="${a.event_id}"]`).val(a.achieved);
                    });
                  }
                }, 500);
              }, 500);
            }, 500);
          });
        }
      }, 500);
    }
  {% endif %}
});

// Disable course selection until a term is selected
$('#add-course').prop('disabled', true);

// When offered term changes, fetch course types
$(document).on('change', '#offered-term', function() {
  const term = $(this).val();
  $('#add-course').prop('disabled', !term);
  $("#courses-container").empty();
  courseIdx = 0;
  if (term) {
    fetch("{% url 'gpacalc-api:get_course_types' %}", {
      method: 'POST',
      headers: {'Content-Type':'application/json','X-CSRFToken':'{{ csrf_token }}'},
      body: JSON.stringify({offered_term: term})
    })
    .then(r=>r.json())
    .then(types=>{
      // Store types globally or pass to addCourseBlock
      window.currentCourseTypes = types;
      addCourseBlock();
    });
  }
});

// Add a new course selector block
function addCourseBlock() {
  const idx = courseIdx++;
  let typeOptions = '<option value="">-- select --</option>';
  if (window.currentCourseTypes) {
    window.currentCourseTypes.forEach(t => {
      typeOptions += `<option value="${t}">${t}</option>`;
    });
  }
  const block = $(`
    <div class="course-block" data-idx="${idx}">
      <label>Type:
        <select class="ctype" name="course_type">
          ${typeOptions}
        </select>
      </label>
      <label>Code:
        <select class="ccode" name="course_code"><option></option></select>
      </label>
      <label>Section:
        <select class="csec" name="section_number"><option></option></select>
      </label>
      <div class="events"></div>
    </div>
  `);
  $("#courses-container").append(block);
}

// load codes when type changes
$(document).on('change', '.ctype', function(){
  const parent = $(this).closest('.course-block');
  const type = $(this).val();
  const term = $('#offered-term').val();
  parent.find('.ccode').empty().append('<option>Loading…</option>');
  parent.find('.csec').empty().append('<option></option>');
  parent.find('.events').empty();
  fetch("{% url 'gpacalc-api:get_course_codes' %}", {
    method: 'POST',
    headers: {'Content-Type':'application/json','X-CSRFToken':'{{ csrf_token }}'},
    body: JSON.stringify({course_type: type, offered_term: term})
  })
  .then(r=>r.json())
  .then(list=>{
    const sel = parent.find('.ccode').empty().append('<option></option>');
    list.forEach(c=> sel.append(`<option value="${c}">${c}</option>`));
  });
});

// load sections when code changes
$(document).on('change', '.ccode', function(){
  const parent = $(this).closest('.course-block');
  const type = parent.find('.ctype').val();
  const code = $(this).val();
  const term = $('#offered-term').val();
  parent.find('.csec').empty().append('<option>Loading…</option>');
  parent.find('.events').empty();
  fetch("{% url 'gpacalc-api:get_section_numbers' %}", {
    method: 'POST',
    headers: {'Content-Type':'application/json','X-CSRFToken':'{{ csrf_token }}'},
    body: JSON.stringify({course_type: type, course_code: code, offered_term: term})
  })
  .then(r=>r.json())
  .then(list=>{
    const sel = parent.find('.csec').empty().append('<option></option>');
    list.forEach(s=> sel.append(`<option value="${s}">${s}</option>`));
  });
});

// load events when section changes
$(document).on('change', '.csec', function(){
  const parent = $(this).closest('.course-block');
  const type = parent.find('.ctype').val();
  const code = parent.find('.ccode').val();
  const sec  = $(this).val();
  const term = $('#offered-term').val();
  parent.find('.events').html('Loading events…');
  fetch("{% url 'gpacalc-api:get_course_events' %}", {
    method: 'POST',
    headers: {'Content-Type':'application/json','X-CSRFToken':'{{ csrf_token }}'},
    body: JSON.stringify({
      course_type: type,
      course_code: code,
      section_number: sec,
      offered_term: term
    })
  })
  .then(r=>r.json())
  .then(evs=>{
    let tbl = `<table class="assess-table">
      <tr><th>Event</th><th>Weight (%)</th><th>Your %</th></tr>`;
    evs.forEach(e=>{
      tbl += `<tr>
        <td>${e.event_type}</td>
        <td>${e.weightage}</td>
        <td>
          <input type="number" step="0.01" min="0" max="100"
                 class="achieved"
                 data-ev-id="${e.id}"
                 placeholder="e.g. 85">
        </td>
      </tr>`;
    });
    tbl += `</table>`;
    parent.find('.events').html(tbl);
  });
});

// add-course button
$('#add-course').click(e=>{
  e.preventDefault();
  addCourseBlock();
});

// calculate GPA
$('#calc-gpa').click(async e => {
  const term = $('#offered-term').val();
  const payload = {courses: [], offered_term: term};
  $('.course-block').each(function(){
    const block = $(this);
    const type = block.find('.ctype').val();
    const code = block.find('.ccode').val();
    const sec  = block.find('.csec').val();
    if (!type||!code||!sec) return;
    const assessments = [];
    block.find('.achieved').each(function(){
      const val = parseFloat($(this).val());
      if (!isNaN(val)) {
        assessments.push({
          event_id: $(this).data('ev-id'),
          achieved: val
        });
      }
    });
    payload.courses.push({course_type: type, course_code: code, section_number: sec, assessments});
  });

  const res = await fetch("{% url 'gpacalc-api:calculate_gpa' %}", {
    method: 'POST',
    headers:{'Content-Type':'application/json','X-CSRFToken':'{{ csrf_token }}'},
    body: JSON.stringify(payload)
  });
  const data = await res.json();
  // render results
  $('#result-header').show();
  let html = `<p><strong>Overall GPA:</strong> ${data.overall_gpa}</p>`;
  html += '<ul>';
  data.per_course.forEach(c=>{
    html += `<li>${c.course}: ${c.final_percentage}% → ${c.letter_grade} → ${c.gpa_value}</li>`;
  });
  html += '</ul>';
  $('#results').html(html);
});

$('#export-excel').click(function() {
  window.location.href = '{% url "gpacalc-api:progress_export_excel" %}';
});

function updateAuthUI(user) {
  if (user) {
    document.getElementById("auth-logged-in").style.display = "";
    document.getElementById("auth-logged-out").style.display = "none";
    document.getElementById("username").textContent = user.username;
  } else {
    document.getElementById("auth-logged-in").style.display = "none";
    document.getElementById("auth-logged-out").style.display = "";
    document.getElementById("username").textContent = "";
  }
}

async function checkAuthStatus() {
  try {
    const resp = await fetch("/api/auth/user/");
    if (resp.ok) {
      const data = await resp.json();
      updateAuthUI(data.user);
    } else {
      updateAuthUI(null);
    }
  } catch {
    updateAuthUI(null);
  }
}

async function login(username, password) {
  try {
    const resp = await fetch("/api/auth/login/", {
      method: "POST",
      headers: {"Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}"},
      body: JSON.stringify({username, password})
    });
    if (resp.ok) {
      const data = await resp.json();
      updateAuthUI(data.user);
      document.getElementById("login-modal").style.display = "none";
      document.getElementById("login-error").style.display = "none";
      location.reload(); // reload to show progress if any
    } else {
      const err = await resp.json();
      document.getElementById("login-error").textContent = err.error || "Login failed";
      document.getElementById("login-error").style.display = "";
    }
  } catch {
    document.getElementById("login-error").textContent = "Network error";
    document.getElementById("login-error").style.display = "";
  }
}

async function logout() {
  await fetch("/api/auth/logout/", {method: "POST", headers: {"X-CSRFToken": "{{ csrf_token }}"}});
  updateAuthUI(null);
  location.reload();
}

document.addEventListener("DOMContentLoaded", function() {
  checkAuthStatus();

  document.getElementById("login-btn").onclick = function() {
    document.getElementById("login-modal").style.display = "";
  };
  document.getElementById("login-cancel").onclick = function() {
    document.getElementById("login-modal").style.display = "none";
    document.getElementById("login-error").style.display = "none";
  };
  document.getElementById("login-submit").onclick = function() {
    const username = document.getElementById("login-username").value;
    const password = document.getElementById("login-password").value;
    if (username && password) login(username, password);
  };
  document.getElementById("logout-btn").onclick = logout;
  document.getElementById("login-password").onkeypress = function(e) {
    if (e.key === "Enter") document.getElementById("login-submit").click();
  };
});
</script>
</body>
</html>