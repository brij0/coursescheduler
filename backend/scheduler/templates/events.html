{% extends "base.html" %}
{% load static %}

{% block title %}Events - CourseScheduler{% endblock %}

{% block extra_css %}
<style>
    body { font-family: 'Poppins', sans-serif; background-color: #f5f4f0; color: #333; }
    .event-query-box { background: #fff; border-radius: 15px; box-shadow: 0 2px 10px #ccc; max-width: 900px; margin: 2rem auto; }
    .course-row { display: flex; gap: 1rem; margin-bottom: 1rem; }
    select, button { padding: 0.5rem; border-radius: 5px; border: 1px solid #ccc; }
    .btn { min-width: 120px; }
    .btn-danger { background: #e74c3c; color: #fff; border: none; }
    .btn-danger:hover { background: #c0392b; }
    .btn-primary { background: #764ba2; color: #fff; border: none; }
    .btn-primary:hover { background: #5a357d; }
    .table { margin-top: 2rem; background: #fff; border-radius: 10px; }
    .table th, .table td { padding: 0.75rem; border-color: #e1e8ed; }
</style>
{% endblock %}

{% block content %}
<div class="event-query-box card p-4 mb-4">
    <h3 class="mb-3">Get Events for Multiple Courses</h3>
    <form id="event-query-form" autocomplete="off">
        <div id="course-rows"></div>
        <button type="button" id="add-course" class="btn btn-secondary mb-3">Add Course</button>
        <button type="submit" class="btn btn-primary mb-3">Show Events</button>
    </form>
    <div id="course-events-result" class="mt-4"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Helper to enable/disable fields
    function setEnabled(el, enabled) { el.disabled = !enabled; }

    // Fetch terms once
    let terms = [];
    fetch('/api/scheduler/offered_terms/')
        .then(res => res.json())
        .then(data => { terms = data; });

    // Add a new course row
    function addCourseRow() {
        const idx = Date.now() + Math.floor(Math.random()*1000);
        const row = document.createElement('div');
        row.className = 'course-row';
        row.dataset.idx = idx;
        row.innerHTML = `
            <select class="term form-control" required>
                <option value="">Term</option>
            </select>
            <select class="type form-control" required disabled>
                <option value="">Type</option>
            </select>
            <select class="code form-control" required disabled>
                <option value="">Code</option>
            </select>
            <select class="section form-control" required disabled>
                <option value="">Section</option>
            </select>
            <button type="button" class="btn btn-danger remove-row">Remove</button>
        `;
        // Populate terms
        const termSel = row.querySelector('.term');
        terms.forEach(term => {
            let opt = document.createElement('option');
            opt.value = term;
            opt.textContent = term;
            termSel.appendChild(opt);
        });

        // Remove row handler
        row.querySelector('.remove-row').onclick = function() {
            row.remove();
        };

        // When term changes, fetch types
        row.querySelector('.term').onchange = function() {
            const term = this.value;
            const typeSel = row.querySelector('.type');
            typeSel.innerHTML = '<option value="">Type</option>';
            setEnabled(typeSel, false);
            setEnabled(row.querySelector('.code'), false);
            setEnabled(row.querySelector('.section'), false);
            row.querySelector('.code').innerHTML = '<option value="">Code</option>';
            row.querySelector('.section').innerHTML = '<option value="">Section</option>';
            if (!term) return;
            fetch('/api/scheduler/course_types/', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({offered_term: term})
            })
            .then(res => res.json())
            .then(data => {
                data.forEach(type => {
                    let opt = document.createElement('option');
                    opt.value = type;
                    opt.textContent = type;
                    typeSel.appendChild(opt);
                });
                setEnabled(typeSel, true);
            });
        };

        // When type changes, fetch codes
        row.querySelector('.type').onchange = function() {
            const term = row.querySelector('.term').value;
            const type = this.value;
            const codeSel = row.querySelector('.code');
            codeSel.innerHTML = '<option value="">Code</option>';
            setEnabled(codeSel, false);
            setEnabled(row.querySelector('.section'), false);
            row.querySelector('.section').innerHTML = '<option value="">Section</option>';
            if (!type) return;
            fetch('/api/scheduler/course_codes/', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({offered_term: term, course_type: type})
            })
            .then(res => res.json())
            .then(data => {
                data.forEach(code => {
                    let opt = document.createElement('option');
                    opt.value = code;
                    opt.textContent = code;
                    codeSel.appendChild(opt);
                });
                setEnabled(codeSel, true);
            });
        };

        // When code changes, fetch sections
        row.querySelector('.code').onchange = function() {
            const term = row.querySelector('.term').value;
            const type = row.querySelector('.type').value;
            const code = this.value;
            const sectionSel = row.querySelector('.section');
            sectionSel.innerHTML = '<option value="">Section</option>';
            setEnabled(sectionSel, false);
            if (!code) return;
            fetch('/api/scheduler/section_numbers/', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({offered_term: term, course_type: type, course_code: code})
            })
            .then(res => res.json())
            .then(data => {
                data.forEach(section => {
                    let opt = document.createElement('option');
                    opt.value = section;
                    opt.textContent = section;
                    sectionSel.appendChild(opt);
                });
                setEnabled(sectionSel, true);
            });
        };

        document.getElementById('course-rows').appendChild(row);
    }

    // Add initial row
    setTimeout(addCourseRow, 300);

    document.getElementById('add-course').onclick = addCourseRow;

    // Handle form submit
    document.getElementById('event-query-form').onsubmit = function(e) {
        e.preventDefault();
        const rows = document.querySelectorAll('.course-row');
        const courses = [];
        for (let row of rows) {
            const term = row.querySelector('.term').value;
            const type = row.querySelector('.type').value;
            const code = row.querySelector('.code').value;
            const section = row.querySelector('.section').value;
            if (term && type && code && section) {
                courses.push({
                    offered_term: term,
                    course_type: type,
                    course_code: code,
                    section_number: section
                });
            }
        }
        if (!courses.length) {
            document.getElementById('course-events-result').innerHTML = '<div class="alert alert-warning">Please select at least one course.</div>';
            return;
        }
        fetch('/api/scheduler/events_view/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({courses: courses})
        })
        .then(res => res.json())
        .then(data => {
            const events = data.events || [];
            let html = '';
            if (!events.length) {
                html = '<div class="alert alert-warning">No events found for these courses.</div>';
            } else {
                html = `<div class="course-card card"><div class="card-body"><h5 class="course-header">Events</h5>
                <table class="table"><thead><tr>
                <th>Course</th><th>Event Type</th><th>Event Date</th><th>Time</th><th>Location</th><th>Description</th><th>Weightage</th>
                </tr></thead><tbody>`;
                events.forEach(event => {
                    html += `<tr>
                        <td>${event.course || ''}</td>
                        <td>${event.event_type}</td>
                        <td>${event.event_date || ''}</td>
                        <td>${event.time || ''}</td>
                        <td>${event.location || ''}</td>
                        <td>${event.description || ''}</td>
                        <td>${event.weightage || ''}</td>
                    </tr>`;
                });
                html += '</tbody></table></div></div>';
            }
            document.getElementById('course-events-result').innerHTML = html;
        });
    };
});
</script>
{% endblock %}